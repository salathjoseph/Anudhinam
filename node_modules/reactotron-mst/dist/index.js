"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var mobxStateTree=require("mobx-state-tree"),reactotronCoreClient=require("reactotron-core-client"),ramda=require("ramda");function _typeof(a){"@babel/helpers - typeof";return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"==typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},_typeof(a)}var dotPath=function(a,b){return ramda.path(ramda.split(".",a),b)},isNilOrEmpty=function(a){return ramda.isNil(a)||ramda.isEmpty(a)},isReactNativeEvent=function(a){return"undefined"!=typeof a&&null!==a&&ramda.has("nativeEvent",a)&&ramda.has("target",a)&&ramda.has("type",a)},convertUnsafeArguments=function(a){var b=Array.isArray(a)?a:[a];return b.map(function(a){return isReactNativeEvent(a)?"ReactNativeEvent":a})},isSerializedActionCall=function(a){return"object"===_typeof(a)&&"name"in a&&"string"==typeof a.name&&(!("path"in a)||"string"==typeof a.path)&&(!("args"in a)||Array.isArray(a.args))},isSerializedActionCallArray=function(a){return Array.isArray(a)&&a.every(isSerializedActionCall)};function mst(){var a=0<arguments.length&&arguments[0]!==void 0?arguments[0]:{};return function(b){function c(a,c){mobxStateTree.onSnapshot(a,j),mobxStateTree.addMiddleware(a,function(d,e){var f="action"!==d.type;if(f)return e(d);var g=o(d);if(!g)return e(d);var h=convertUnsafeArguments(d.args),i=mobxStateTree.getPath(d.context),j={args:h,name:d.name,path:i},k={id:d.id,parentId:d.parentId,rootId:d.rootId,type:d.type,modelType:mobxStateTree.getType(a),alive:mobxStateTree.isAlive(a),root:mobxStateTree.isRoot(a),protected:mobxStateTree.isProtected(a)},l=b.startTimer(),n=e(d),p=l(),q=ramda.replace(/^\./,"",ramda.replace(/\//g,".",i)),r=ramda.replace(/^\./,"","".concat(null!==c&&void 0!==c?c:"").concat(q,".").concat(d.name,"()"));return r=ramda.replace("/",".",r),m||b.send("state.action.complete",{name:r,action:j,mst:k,ms:p}),n})}function d(a){var c=l["mstNodeName"in a&&"string"==typeof a.mstNodeName?a.mstNodeName:"default"];if(c&&c.node){var d=mobxStateTree.getSnapshot(c.node);b.send("state.backup.response",{state:d})}}function e(a){var b=l["mstNodeName"in a&&"string"==typeof a.mstNodeName?a.mstNodeName:"default"],c=a&&a.payload&&a.payload.state;if(b&&b.node){var d=b.node;m=!0,mobxStateTree.applySnapshot(d,c),m=!1}}function f(a){var b=l["mstNodeName"in a&&"string"==typeof a.mstNodeName?a.mstNodeName:"default"],c=a&&a.payload&&a.payload.action,d=isSerializedActionCall(c)||isSerializedActionCallArray(c);if(b&&b.node&&c&&d){var e=b.node;try{mobxStateTree.applyAction(e,c)}catch(a){}}}function g(b){var c=l["mstNodeName"in b&&"string"==typeof b.mstNodeName?b.mstNodeName:"default"],d=b&&b.payload&&b.payload.paths||[];if(d&&(n=ramda.uniq(ramda.flatten(d))),c&&c.node){var e="snapshot"===a.queryMode?mobxStateTree.getSnapshot(c.node):c.node;j(e)}}function h(a){var b,c=l["mstNodeName"in a&&"string"==typeof a.mstNodeName?a.mstNodeName:"default"],d=null===a||void 0===a||null===(b=a.payload)||void 0===b?void 0:b.path;if(c&&c.node){var e=mobxStateTree.getSnapshot(c.node);if(isNilOrEmpty(d))k.stateKeysResponse(null,ramda.keys(e).map(function(a){return a.toString()}));else{var f=ramda.keys(dotPath(d,e));k.stateKeysResponse(d,f)}}}function i(a){var b,c=l["mstNodeName"in a&&"string"==typeof a.mstNodeName?a.mstNodeName:"default"],d=null===a||void 0===a||null===(b=a.payload)||void 0===b?void 0:b.path;if(c&&c.node){var e=mobxStateTree.getSnapshot(c.node);isNilOrEmpty(d)?k.stateValuesResponse(null,e):k.stateValuesResponse(d,dotPath(d,e))}}function j(a){var b=ramda.pipe(ramda.map(ramda.when(ramda.isNil,ramda.always(""))),ramda.filter(ramda.endsWith(".*")),ramda.map(function(b){var c=ramda.slice(0,-2,b),d=dotPath(c,a);return ramda.is(Object,d)&&!isNilOrEmpty(d)?ramda.pipe(ramda.keys,ramda.map(function(a){return"".concat(c,".").concat(a)}))(d||{}):[]}),ramda.concat(ramda.map(ramda.when(ramda.isNil,ramda.always("")),n)),ramda.flatten,ramda.reject(ramda.endsWith(".*")),ramda.uniq,ramda.sortBy(ramda.identity),ramda.map(function(b){return{path:b,value:isNilOrEmpty(b)?a:dotPath(b,a)}}))(n);k.stateValuesChange(b)}reactotronCoreClient.assertHasStateResponsePlugin(b);var k=b,l={},m=!1,n=[],o=a.filter?a.filter:function(){return!0},p={"state.backup.request":d,"state.restore.request":e,"state.action.dispatch":f,"state.values.subscribe":g,"state.keys.request":h,"state.values.request":i};return{onCommand:function(a){var b=p[a&&a.type];b&&b(a)},features:{trackMstNode:function(a){var b=1<arguments.length&&arguments[1]!==void 0?arguments[1]:"default";if(!a)return{kind:"required"};if(l[b])return{kind:"already-tracking"};try{var d=mobxStateTree.getType(a);if(mobxStateTree.isType(d))try{return c(a),l[b]={node:a,modelType:d},{kind:"ok"}}catch(a){return{kind:"tracking-error",message:a instanceof Error?a.message:"Unknown error - tracking error did not have message"}}else return{kind:"invalid-node"}}catch(a){return{kind:"invalid-node"}}}}}}}exports.mst=mst;
